<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chest X-ray Analysis</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
        .prediction-bar {
            height: 20px;
            background-color: #007bff;
            margin-bottom: 5px;
        }
        .result-row {
            margin-bottom: 10px;
        }
        .positive-finding {
            background-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-bottom: 10px;
        }
        .low-confidence-finding {
            background-color: rgba(23, 162, 184, 0.1);
            border-left: 4px solid #17a2b8;
            padding: 10px;
            margin-bottom: 10px;
        }
        #dropArea {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #dropArea:hover {
            background-color: #f8f9fa;
        }
        #gradcamContainer img {
            max-width: 100%;
            height: auto;
            margin-top: 15px;
            cursor: zoom-in;
        }
        /* Modal styles for image zoom */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
        }
        .zoom-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .zoomed-image {
            transform-origin: center;
            transition: transform 0.1s ease;
            cursor: zoom-out;
            max-width: 90%;
            max-height: 90vh;
        }
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1060;
            background-color: rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 10px;
        }
        .close-modal {
            position: fixed;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1070;
        }
        .close-modal:hover {
            color: #bbb;
        }
        .metadata-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .metadata-item:last-child {
            border-bottom: none;
        }
        .metadata-label {
            font-weight: 600;
            color: #495057;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                font-size: 12pt;
            }
            .card {
                border: none !important;
            }
            .card-header {
                background-color: #f8f9fa !important;
                color: #000 !important;
            }
        }
        .print-only {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h1 class="text-center mb-4">Chest X-ray AI Analysis</h1>
                
                <div class="card mb-4 no-print">
                    <div class="card-body">
                        <h5 class="card-title">Upload X-ray Image</h5>
                        <div class="alert alert-info mt-2">
                            <small>
                                <strong>Supported file types:</strong> 
                                <ul class="mb-0">
                                    <li>Regular image files (JPEG, PNG, etc.)</li>
                                    <li>DICOM (.DCM) files - with viewer tools for pan, zoom, and window/level adjustment</li>
                                </ul>
                            </small>
                        </div>
                        <div id="dropArea" class="mb-3">
                            <p>Drag and drop your X-ray image here or click to select a file</p>
                            <input type="file" id="fileInput" class="d-none" accept="image/*,.dcm">
                        </div>
                        <div id="uploadPreview" class="text-center d-none mb-3">
                            <img id="previewImage" class="img-fluid" style="max-height: 300px;">
                            <!-- DICOM viewer container -->
                        <div id="dicomContainer" class="position-relative" style="height: 300px; display: none;">
                            <div id="dicomViewer" style="width: 100%; height: 100%;"></div>
                            <div class="position-absolute bottom-0 start-0 p-2 bg-dark bg-opacity-50 text-white small">
                                <span id="dicomInfo">DICOM Image</span>
                            </div>
                        </div>
                        </div>
                        <div class="text-center">
                            <button id="analyzeBtn" class="btn btn-primary" disabled>Analyze X-ray</button>
                        </div>
                    </div>
                </div>
                
                <div id="resultsCard" class="card d-none mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingResults" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing image... This may take a few moments.</p>
                        </div>
                        
                        <div id="resultsContent" class="d-none">
                            <h6 class="mb-3">Findings:</h6>
                            <div id="positiveFindings" class="mb-4"></div>
                            
                            <h6 class="mb-3">All Conditions Analysis:</h6>
                            <div id="allPredictions"></div>
                        </div>
                    </div>
                </div>
                
                <div id="gradcamCard" class="card d-none mb-4 no-print">
                    <div class="card-header">
                        <h5 class="mb-0">Visual Explanation (GradCAM)</h5>
                    </div>
                    <div class="card-body">
                        <p>Select a condition to visualize regions that influenced the model's prediction:</p>
                        <select id="diseaseSelect" class="form-select mb-3"></select>
                        <div id="gradcamContainer" class="text-center"></div>
                        <p class="text-muted mt-2"><small>Click on the image to zoom in and out for detailed inspection.</small></p>
                    </div>
                </div>
                
                <!-- New Medical Report Card -->
                <div id="reportCard" class="card d-none mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Medical Report</h5>
                        <div class="no-print">
                            <button id="generateReportBtn" class="btn btn-outline-primary btn-sm me-2">Generate Report</button>
                            <button id="printReportBtn" class="btn btn-outline-secondary btn-sm">Print Report</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="loadingReport" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Generating medical report...</p>
                        </div>
                        
                        <div id="reportContent" class="d-none">
                            <!-- Report header with logo and title -->
                            <div class="row print-only mb-4">
                                <div class="col-12 text-center">
                                    <h3>Chest X-ray Analysis Report</h3>
                                    <p class="text-muted">Generated on <span id="reportDate"></span></p>
                                </div>
                            </div>
                            
                            <!-- Image and metadata section -->
                            <div class="row mb-4">
                                <div class="col-md-6 text-center mb-3">
                                    <h6>X-ray Image</h6>
                                    <img id="reportImage" class="img-fluid" style="max-height: 300px;">
                                </div>
                                <div class="col-md-6">
                                    <h6>DICOM Metadata</h6>
                                    <div id="dicomMetadata" class="border rounded p-2">
                                        <div class="text-center text-muted py-3">No DICOM metadata available</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Findings section -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6>Positive Findings</h6>
                                    <div id="reportPositiveFindings">
                                        <div class="text-center text-muted py-3">No abnormalities detected with high confidence</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Low confidence findings -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6>Low Confidence Findings</h6>
                                    <div id="reportLowConfidenceFindings">
                                        <div class="text-center text-muted py-3">No low confidence findings to report</div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4 no-print">
                    <strong>Disclaimer:</strong> This analysis should be reviewed by a qualified radiologist. It is not intended to replace professional medical diagnosis.
                </div>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <div class="zoom-container">
            <img id="zoomedImage" class="zoomed-image">
        </div>
        <div class="zoom-controls">
            <button id="zoomInBtn" class="btn btn-sm btn-light me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-zoom-in" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                    <path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/>
                    <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/>
                </svg>
            </button>
            <button id="zoomOutBtn" class="btn btn-sm btn-light me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-zoom-out" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                    <path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/>
                    <path fill-rule="evenodd" d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            <button id="resetZoomBtn" class="btn btn-sm btn-light">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
                </svg>
            </button>
            <button id="closeModalBtn" class="btn btn-sm btn-secondary ms-2">Close</button>
        </div>
    </div>

   <!-- DICOM Libraries -->
    <!-- Core Cornerstone -->
    <script src="js/cornerstone.min.js"></script>
    <!-- Math Utilities -->
    <script src="js/cornerstoneMath.min.js"></script>
    <!-- DICOM Parser -->
    <script src="js/dicomParser.min.js"></script>
    <!-- WADO Image Loader -->
    <script src="js/cornerstoneWADOImageLoader.min.js"></script>
    <!-- Cornerstone Tools -->
    <script src="js/cornerstoneTools.min.js"></script>

    <script>
        
        // Configuration - Replace with your API endpoint
        const API_ENDPOINT = 'http://localhost:9090';
        
        // DOM elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const uploadPreview = document.getElementById('uploadPreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsCard = document.getElementById('resultsCard');
        const loadingResults = document.getElementById('loadingResults');
        const resultsContent = document.getElementById('resultsContent');
        const positiveFindings = document.getElementById('positiveFindings');
        const allPredictions = document.getElementById('allPredictions');
        const gradcamCard = document.getElementById('gradcamCard');
        const diseaseSelect = document.getElementById('diseaseSelect');
        const gradcamContainer = document.getElementById('gradcamContainer');
        
        // Report elements
        const reportCard = document.getElementById('reportCard');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const printReportBtn = document.getElementById('printReportBtn');
        const loadingReport = document.getElementById('loadingReport');
        const reportContent = document.getElementById('reportContent');
        const reportDate = document.getElementById('reportDate');
        const reportImage = document.getElementById('reportImage');
        const dicomMetadata = document.getElementById('dicomMetadata');
        const reportPositiveFindings = document.getElementById('reportPositiveFindings');
        const reportLowConfidenceFindings = document.getElementById('reportLowConfidenceFindings');
        
        // Modal elements
        const imageModal = document.getElementById('imageModal');
        const zoomedImage = document.getElementById('zoomedImage');
        const closeModal = document.querySelector('.close-modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        
        // Zoom functionality variables
        let currentZoom = 1;
        const zoomStep = 0.25;
        const maxZoom = 5;
        const minZoom = 0.5;
        
        // File handling
        let selectedFile = null;
        let imageDataUrl = null;


        // Initialize Cornerstone for DICOM viewing
        function initializeCornerstone() {
            try {
                // Set up external dependencies
                cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
                cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
                cornerstoneTools.external.cornerstone = cornerstone;
                cornerstoneTools.external.cornerstoneMath = cornerstoneMath;
        
                // Configure WADO Image Loader
                cornerstoneWADOImageLoader.configure({
                    useWebWorkers: false,
                    strict: false
                });
        
                // Enable the DICOM viewer element
                cornerstone.enable(document.getElementById('dicomViewer'));
        
                // Initialize Cornerstone Tools
                cornerstoneTools.init();
            } catch (error) {
                console.error('Error initializing Cornerstone:', error);
                alert('Error initializing DICOM viewer. Some features may not work correctly.');
            }
        }
        
        // Event listeners
        dropArea.addEventListener('click', () => fileInput.click());
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#007bff';
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#ccc';
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#ccc';
            
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
        
        analyzeBtn.addEventListener('click', analyzeImage);
        generateReportBtn.addEventListener('click', generateReport);
        printReportBtn.addEventListener('click', () => window.print());
        
        diseaseSelect.addEventListener('change', generateGradCAM);
        
        // Zoom functionality
        closeModal.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });
        
        closeModalBtn.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });

        // Add shortcuts for DICOM navigation
        window.addEventListener('keydown', (e) => {
            if (document.getElementById('dicomContainer').style.display === 'block') {
                if (e.key === 'ArrowUp') {
                    // Increase brightness/contrast
                    cornerstoneTools.setToolActive('Wwwc', {});
                    const eventData = {
                        deltaY: -10,
                        preventDefault: () => {}
                    };
                    cornerstoneTools.getToolForElement(document.getElementById('dicomViewer'), 'Wwwc').mouseWheelCallback(eventData);
                } else if (e.key === 'ArrowDown') {
                    // Decrease brightness/contrast
                    cornerstoneTools.setToolActive('Wwwc', {});
                    const eventData = {
                        deltaY: 10,
                        preventDefault: () => {}
                    };
                    cornerstoneTools.getToolForElement(document.getElementById('dicomViewer'), 'Wwwc').mouseWheelCallback(eventData);
                } else if (e.key === 'r') {
                    // Reset view
                    cornerstone.reset(document.getElementById('dicomViewer'));
                }
            }
        });
        
        zoomInBtn.addEventListener('click', () => {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                updateZoom();
            }
        });
        
        zoomOutBtn.addEventListener('click', () => {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                updateZoom();
            }
        });
        
        resetZoomBtn.addEventListener('click', () => {
            currentZoom = 1;
            updateZoom();
        });
        
        // Add keyboard shortcuts for zooming
        window.addEventListener('keydown', (e) => {
            if (imageModal.style.display === 'block') {
                if (e.key === '+' || e.key === '=') {
                    if (currentZoom < maxZoom) {
                        currentZoom += zoomStep;
                        updateZoom();
                    }
                } else if (e.key === '-') {
                    if (currentZoom > minZoom) {
                        currentZoom -= zoomStep;
                        updateZoom();
                    }
                } else if (e.key === '0') {
                    currentZoom = 1;
                    updateZoom();
                } else if (e.key === 'Escape') {
                    imageModal.style.display = 'none';
                }
            }
        });
        
        function updateZoom() {
            zoomedImage.style.transform = `scale(${currentZoom})`;
        }
        
        // Functions
        async function analyzeImage() {
            if (!selectedFile) return;
            
            // Show results card with loading state
            resultsCard.classList.remove('d-none');
            loadingResults.classList.remove('d-none');
            resultsContent.classList.add('d-none');
            gradcamCard.classList.add('d-none');
            reportCard.classList.add('d-none');
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', selectedFile); // Send the original file
                
                // If it's a DICOM file, add some metadata
                if (selectedFile.name.toLowerCase().endsWith('.dcm')) {
                    formData.append('is_dicom', 'true');
                }
                
                // Make API request
                const response = await fetch(`${API_ENDPOINT}/predict`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Analysis failed');
                }
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert('Error analyzing image: ' + error.message);
                resultsCard.classList.add('d-none');
            }
        }
        function displayResults(data) {
            // Hide loading state
            loadingResults.classList.add('d-none');
            resultsContent.classList.remove('d-none');
            
            // Clear previous results
            positiveFindings.innerHTML = '';
            allPredictions.innerHTML = '';
            
            // Display positive findings
            const positiveFindingsArray = data.summary.positive_findings;
            
            if (positiveFindingsArray.length === 0) {
                positiveFindings.innerHTML = '<div class="alert alert-success">No abnormalities detected with high confidence.</div>';
            } else {
                positiveFindingsArray.forEach(finding => {
                    const elem = document.createElement('div');
                    elem.className = 'positive-finding';
                    elem.innerHTML = `
                        <h6>${finding.disease}</h6>
                        <p>Detected with ${(finding.probability * 100).toFixed(1)}% probability</p>
                    `;
                    positiveFindings.appendChild(elem);
                });
            }
            
            // Display all predictions
            const predictionEntries = Object.entries(data.predictions)
                .map(([disease, data]) => ({ 
                    disease, 
                    probability: typeof data === 'object' ? data.probability : data,
                    threshold: typeof data === 'object' ? data.threshold : 0.5,
                    detected: typeof data === 'object' ? data.detected : false
                }))
                .sort((a, b) => b.probability - a.probability);
            
            predictionEntries.forEach(pred => {
                const row = document.createElement('div');
                row.className = 'result-row';
                const probability = pred.probability * 100;
                
                row.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span>${pred.disease}</span>
                        <span>${probability.toFixed(1)}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar ${pred.detected ? 'bg-warning' : ''}" 
                             style="width: ${probability}%"></div>
                        <div class="progress-bar bg-light" style="width: ${100 - probability}%"></div>
                    </div>
                `;
                
                allPredictions.appendChild(row);
            });
            
            // Prepare GradCAM visualization dropdown
            diseaseSelect.innerHTML = '';
            predictionEntries.forEach(pred => {
                const option = document.createElement('option');
                option.value = pred.disease;
                option.innerText = `${pred.disease} (${(pred.probability * 100).toFixed(1)}%)`;
                diseaseSelect.appendChild(option);
            });
            
            // Show GradCAM card
            gradcamCard.classList.remove('d-none');
            
            // Show report button
            reportCard.classList.remove('d-none');
            loadingReport.classList.add('d-none');
            reportContent.classList.add('d-none');
            
            // Generate initial GradCAM for the top disease
            if (predictionEntries.length > 0) {
                diseaseSelect.value = predictionEntries[0].disease;
                generateGradCAM();
            }
        }
        
        async function generateGradCAM() {
            if (!selectedFile) return;
            
            const disease = diseaseSelect.value;
            if (!disease) return;
            
            // Show loading in GradCAM container
            gradcamContainer.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating visualization...</p>
            `;
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('disease', disease);
                
                // Make API request
                const response = await fetch(`${API_ENDPOINT}/gradcam`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('GradCAM generation failed');
                }
                
                const data = await response.json();
                
                // Display GradCAM image
                gradcamContainer.innerHTML = `
                    <p>Highlighted areas show regions that influenced the model's prediction for ${disease}:</p>
                    <img src="${data.gradcam_image}" alt="GradCAM visualization" class="img-fluid" id="gradcamImage">
                `;
                
                // Add click event to open zoomed view
                const gradcamImage = document.getElementById('gradcamImage');
                gradcamImage.addEventListener('click', () => {
                    zoomedImage.src = data.gradcam_image;
                    imageModal.style.display = 'block';
                    currentZoom = 1;
                    updateZoom();
                });
            } catch (error) {
                gradcamContainer.innerHTML = `<div class="alert alert-danger">Error generating visualization: ${error.message}</div>`;
            }
        }
        
        async function generateReport() {
            if (!selectedFile) return;
            
            // Show report card with loading state
            reportCard.classList.remove('d-none');
            loadingReport.classList.remove('d-none');
            reportContent.classList.add('d-none');
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                // Make API request
                const response = await fetch(`${API_ENDPOINT}/report`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Report generation failed');
                }
                
                const data = await response.json();
                displayReport(data);
            } catch (error) {
                alert('Error generating report: ' + error.message);
                loadingReport.classList.add('d-none');
                reportContent.classList.add('d-none');
                reportCard.classList.add('d-none');
            }
        }
        
        function displayReport(data) {
            // Hide loading state
            loadingReport.classList.add('d-none');
            reportContent.classList.remove('d-none');
            
            // Set report date
            reportDate.textContent = new Date().toLocaleString();
            
            // Set report image
            reportImage.src = imageDataUrl || previewImage.src;
            
            // Display DICOM metadata if available
            if (data.metadata && Object.keys(data.metadata).length > 0) {
                dicomMetadata.innerHTML = '';
                for (const [key, value] of Object.entries(data.metadata)) {
                    const item = document.createElement('div');
                    item.className = 'metadata-item';
                    item.innerHTML = `<span class="metadata-label">${key}:</span> ${value}`;
                    dicomMetadata.appendChild(item);
                }
            } else {
                dicomMetadata.innerHTML = '<div class="text-center text-muted py-3">No DICOM metadata available</div>';
            }
            
            // Display positive findings
            if (data.positive_findings && data.positive_findings.length > 0) {
                reportPositiveFindings.innerHTML = '';
                data.positive_findings.forEach(finding => {
                    const elem = document.createElement('div');
                    elem.className = 'positive-finding';
                    elem.innerHTML = `
                        <h6>${finding.disease}</h6>
                        <p>Detected with ${(finding.probability * 100).toFixed(1)}% probability</p>
                        <p>${finding.description || ''}</p>
                    `;
                    reportPositiveFindings.appendChild(elem);
                });
            } else {
                reportPositiveFindings.innerHTML = '<div class="text-center text-muted py-3">No abnormalities detected with high confidence</div>';
            }
            
            // Display low confidence findings
            if (data.low_confidence_findings && data.low_confidence_findings.length > 0) {
                reportLowConfidenceFindings.innerHTML = '';
                data.low_confidence_findings.forEach(finding => {
                    const elem = document.createElement('div');
                    elem.className = 'low-confidence-finding';
                    elem.innerHTML = `
                        <h6>${finding.disease}</h6>
                        <p>Detected with ${(finding.probability * 100).toFixed(1)}% probability</p>
                        <p>${finding.description || ''}</p>
                    `;
                    reportLowConfidenceFindings.appendChild(elem);
                });
            } else {
                reportLowConfidenceFindings.innerHTML = '<div class="text-center text-muted py-3">No low confidence findings to report</div>';
            }
        }
    
        
        function repairDicomBuffer(arrayBuffer) {
            if (arrayBuffer.byteLength < 132) {
                console.warn("File is too small to be a valid DICOM. Skipping repair.");
                return arrayBuffer;
            }
            
            const dataView = new DataView(arrayBuffer);
            // Read the 4 bytes starting at offset 128
            const prefix = String.fromCharCode(
                dataView.getUint8(128),
                dataView.getUint8(129),
                dataView.getUint8(130),
                dataView.getUint8(131)
            );
            
            if (prefix === "DICM") {
                // The file is already valid.
                return arrayBuffer;
            } else {
                console.log("Repairing DICOM file: 'DICM' header missing. Inserting preamble and header.");
                // Create a new Uint8Array: 128 bytes for preamble, 4 bytes for "DICM", plus the original file.
                const repairedArray = new Uint8Array(128 + 4 + arrayBuffer.byteLength);
                // Preable: fill first 128 bytes with 0 (or you could use other values if needed)
                for (let i = 0; i < 128; i++) {
                    repairedArray[i] = 0;
                }
                // Insert "DICM" marker
                repairedArray[128] = "D".charCodeAt(0);
                repairedArray[129] = "I".charCodeAt(0);
                repairedArray[130] = "C".charCodeAt(0);
                repairedArray[131] = "M".charCodeAt(0);
                // Copy the original file content after the header.
                repairedArray.set(new Uint8Array(arrayBuffer), 132);
                return repairedArray.buffer;
            }
        }
        
        async function handleFile(file) {
            if (!file.type.startsWith('image/') && !file.name.toLowerCase().endsWith('.dcm')) {
            alert('Please select an image file or DICOM file');
            return;
            }

            if (file.name.toLowerCase().endsWith('.dcm')) {
            try {
                const fileReader = new FileReader();
                fileReader.onload = async function(event) {
                const arrayBuffer = event.target.result;
                const dataView = new DataView(arrayBuffer);
                const prefix = String.fromCharCode(
                    dataView.getUint8(128),
                    dataView.getUint8(129),
                    dataView.getUint8(130),
                    dataView.getUint8(131)
                );

                if (prefix !== "DICM") {
                    console.log("DICM header missing, attempting repair...");
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_ENDPOINT}/repair_dicom`, {
                    method: 'POST',
                    body: formData
                    });

                    if (!response.ok) throw new Error('DICOM repair failed');

                    const repairedBlob = await response.blob();
                    // Create a File from the blob with a .png filename
                    const repairedFile = new File([repairedBlob], "repaired.png", { type: "image/png" });
                    const repairedUrl = URL.createObjectURL(repairedFile);
                    console.log("Repaired DICOM file:", repairedFile.name);
                    selectedFile = repairedFile; // Use repaired PNG file for analysis instead of original DICOM.
                    analyzeBtn.disabled = false;
                    reportCard.classList.add('d-none');
                    uploadPreview.classList.remove('d-none');
                    previewImage.src = repairedUrl;
                    previewImage.style.display = 'block';
                    document.getElementById('dicomContainer').style.display = 'none';
                } else {
                    console.log("DICM header found, using the file as is.");
                    selectedFile = file;
                    analyzeBtn.disabled = false;
                    reportCard.classList.add('d-none');
                    uploadPreview.classList.remove('d-none');
                    previewImage.style.display = 'none';
                    document.getElementById('dicomContainer').style.display = 'block';
                    initializeCornerstone();
                    loadDicomFile(selectedFile); // Always load as DICOM if valid
                }
                };
                fileReader.onerror = function(error) {
                console.error("Error reading file:", error);
                fallbackToImage(file);
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) {
                alert('DICOM handling failed: ' + error.message);
                fallbackToImage(file); // Fallback to displaying as a normal image if necessary
            }
            } else {
            // Handling for non-DICOM files
            selectedFile = file;
            analyzeBtn.disabled = false;
            reportCard.classList.add('d-none');

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                imageDataUrl = e.target.result;
                uploadPreview.classList.remove('d-none');
                previewImage.style.display = 'block';
                document.getElementById('dicomContainer').style.display = 'none';
            };
            reader.readAsDataURL(file);
            }
        }

        function loadDicomFile(file) {
            const fileReader = new FileReader();
            fileReader.onload = function(e) {
                let arrayBuffer = e.target.result;
                arrayBuffer = repairDicomBuffer(arrayBuffer);
        
                const blob = new Blob([new Uint8Array(arrayBuffer)], { type: "application/dicom" });
                const imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(blob);
        
                // Enable the DICOM viewer
                const dicomViewer = document.getElementById('dicomViewer');
                if (!cornerstone.getEnabledElement(dicomViewer)) {
                    cornerstone.enable(dicomViewer);
                }
        
                // Load and display the DICOM image
                cornerstone.loadAndCacheImage(imageId)
                    .then(function(image) {
                        const viewport = cornerstone.getDefaultViewportForImage(dicomViewer, image);
                        cornerstone.displayImage(dicomViewer, image, viewport);
                        console.log("DICOM loaded successfully.");
                    })
                    .catch(function(error) {
                        console.error("Error loading DICOM:", error);
                        alert("Could not load the DICOM file.");
                    });
            };
            fileReader.readAsArrayBuffer(file);
        }
        

         function fallbackToImage(file) {
            console.log('Falling back to standard image display');
            
            // Try to display as regular image if possible
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    previewImage.src = e.target.result;
                    imageDataUrl = e.target.result;
                    previewImage.style.display = 'block';
                    document.getElementById('dicomContainer').style.display = 'none';
                } catch (error) {
                    console.error('Failed to display as regular image:', error);
                    alert('Unable to display this file. Please try another image.');
                }
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>